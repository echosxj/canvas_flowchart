<%
/**
* Generated by VStation Code Tools
描述：新增流程模板
作者：James,25708164@qq.com,
日期：2017年5月8日
Controller：FlowController
修改记录：
**/
%>
<style>
    .userNameStyle{
        font-weight:800;
        background:#FFFFCC;
        margin-top:5px;border:1px solid #FFF
    }

    .userRowStyle{
        margin-top:5px;border:1px solid #FFF
    }

    .stepName{
        font-weight:300;
        color:#FFF;background:#6699CC;
        border:1px solid #FFF;
    }
    .stepTitle{
        font-weight:800;
        border:1px solid #FFF;
        background:#99CCFF;
    }

    .removeStepRow{
        color:red;
        cursor:pointer;
        background:#99CCFF;
        border:1px solid #FFF;
    }

    .removeUserRow{
        color:red;
        cursor:pointer;
        background:#FFFFCC;
        border:1px solid #FFF;
    }
    .addUserStyle{
        color:blue;border:1px solid #FFF;
        cursor:pointer;
        background:#99CCFF;
    }

    .errStyle{
        color:red;
        display:none;
    }
</style>
<!-- canvas_css.css -->
<style>
    canvas {
        cursor: pointer;
        border: 1px solid black;
        margin:0;
        padding:0;
    }
    #mask{
        position: fixed;
        width: 100%;
        height: 100%;
        background: #FFFFFF;
        top: 0;
        left: 0;
        display: none;
        z-index:9999;
    }
    #canvas_area{
        position:relative;
        -webkit-user-select: none;
        -moz-user-select: none;
        -khtml-user-select: none;
        -ms-user-select: none;
        -o-user-select: none;
        user-select: none;
        overflow: scroll;
        width: 818px;
        height: 518px;
        position:relative;
        left:50%;
        transform:translateX(-50%);
        background:#ffffff;
    }
    .put_canvas_btn{
        position:relative;
        left:50%;
        transform:translateX(-50%);}
    .canvas_style{
        position: absolute;
        -webkit-user-select: none;
        -moz-user-select: none;
        -khtml-user-select: none;
        -ms-user-select: none;
        -o-user-select: none;
        user-select: none;
        z-index: 10;
        transform-origin: 0 0;
        -webkit-transform: scale(1);
        -moz-transform: scale(1);
        -ms-transform: scale(1);
        -o-transform: scale(1);
        transform: scale(1);
    }
    #canvas_none{
        position: absolute;
        z-index: 1;
    }
    #canvas_toolbar{
        width: 800px;
        border: 1px solid black;
        position:relative;
        left:50%;
        transform:translateX(-50%);
    }
    .canvas_btn{
        width: 30px;
        height: 30px;
        display: inline-block;
        margin-left: 10px;
        padding: 1px;
    }

    .canvas_btn_choosed{
        background: darkgray;
    }
    .canvas_btn_unchecked{
        background: #FFFFFF;

    }

    #canvas_btn_toggleDragRect div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/choose.png") center center;
        background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_toggleDrawLine div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/addline.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;

    }
    #canvas_btn_toggleDeleteLine div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/delete.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;

    }
    #canvas_btn_addRect div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/new.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_clearAll div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/clear.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_test div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/test.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_outputData div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/output.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_saveImg div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/download.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_addHeight div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/addheight.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_reduceHeight div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/reduceheight.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }

    #canvas_btn_autoSort div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/sort.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_addWidth div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/addwidth.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_reduceWidth div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/reducewidth.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_enlarge div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/enlarge.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    #canvas_btn_shrink div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/shrink.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;

    }
    #canvas_btn_recovery div{
        background: url("${srpp}/plugins/Canvas_FlowChart/img/recovery.png") center center;   background-size: cover;-moz-background-size: cover;-o-background-size: cover;-webkit-background-size: cover;
    }
    .canvas_btn div{
        background-size:cover; width: 100%;
        height: 100%;
    }
</style>
<!-- 流程弹窗 -->
<!-- '<div class="checkPersonOperation" > <div class="checkPersonName">''</div><div class=”checkPeronDepName“>''</div> <div class="deleteCheckPerson" uIndex="'+persons[i].operatorId+'">-</div> </div>'
			 -->
<style>
    #addCheckPerson{
        width:20px;height:20px;text-align:center;display:inline-block;border-radius:20px;margin-bottom: -5px;
        background:url('${srpp}/plugins/Canvas_FlowChart/img/flowchart_addPerson.png') center no-repeat;background-size:contain;
    }
    .checkPersonOperation{
        border-bottom:1px solid black;
    }

    .checkPersonName{
        width:40%;
        display:inline-block;
    }
    .checkPeronDepName{
        width:40%;
        display:inline-block;
    }
    .deleteCheckPerson{
        width:20px;height:20px;text-align:center;display:inline-block;margin-bottom:-5px;
        background:url('${srpp}/plugins/Canvas_FlowChart/img/flowchart_delPerson.png') center no-repeat;background-size:contain;

    }
    .canvas_wrong{
        border:3px solid #D15E5E;
    }
    .canvas_correct{
        border:3px solid #63CC9E;
    }
</style>

<div  class="box-content"  style="width:100%;height:100%;">
    <div >
        <form   id="${tabId}_Form"  method="post" action=" ${ctx}/flow/save/ " class="form-horizontal">
            <fieldset>
                <div class="form-group">
                    <label class="col-md-3 control-label">流程名称
                        <span class="necessary_text">*</span>
                    </label>
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="name" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label">处理Java类
                        <span class="necessary_text">*</span>
                    </label>
                    <div class="col-md-6">
                        <input type="text" class="form-control" name="handleClass" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label">是否可用
                        <span class="necessary_text">*</span>
                    </label>
                    <div class="col-md-6">
                        <div class="radio-inline" style="margin-left:15px;">
                            <label>
                                <input type="radio" name="status" checked value="1">是
                                <i class="fa fa-circle-o"></i>
                            </label>
                        </div>
                        <div class="radio-inline">
                            <label>
                                <input type="radio" name="status"  value="0"> 否
                                <i class="fa fa-circle-o"></i>
                            </label>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label">备注
                    </label>
                    <div class="col-md-6">
                        <textarea  class="form-control" name="remark"  rows="6"></textarea>
                    </div>
                </div>
                <div class="form-group">
                    <label class="col-md-3 control-label">审批步骤
                        <span class="necessary_text">*</span>
                    </label>

                </div>

            </fieldset>
            <!--  Canvas位置 -->
            <div id="canvas_area">
                <canvas id="canvas_flowchart" class="canvas_style">
                </canvas>
            </div>
            <div id="put_canvas_btn" class='put_canvas_btn'></div>

            <div class="form-group"  style="margin-top:60px;">
                <div class="col-md-9 col-sm-offset-3">
                    <button type="button"  id="btn_${tabId}_submit" class="btn btn-large btn-info btn-label-left"  style="margin-right:30px;font-size:14px">
                        <span><i class="glyphicon glyphicon-ok"></i></span>
                        保存
                    </button>
                    <button type="button"  id="btn_${tabId}_cancel" class="btn btn-large btn-label-left" style="font-size:14px">
                        <span><i class="glyphicon glyphicon-remove"></i></span>
                        关闭
                    </button>
                </div>
            </div>
        </form>
    </div>
</div>

<!--  隐藏 增加步骤layer 弹窗  -->
<div id="newStepDiv"  style="display:none;padding-top:10px;" >
    <div class="row form-group"  style="width:95%;padding-left:8px;" >
        <label class="col-md-5"  >
            步骤名称：
        </label>
        <div class="col-md-7">
            <input type="text"  id='stepName'  name="stepName"  />
            <span id="err_StepName"  class="errStyle">请填写步骤名称</span>
        </div>
    </div>
    <div class="row form-group"   style="width:95%;padding-left:8px;">
        <label class="col-md-5" >
            是否会签：
        </label>
        <div class="col-md-7">
            <div class="radio-inline" style="margin-left:15px;">
                <label>
                    <input type="radio" name="signType" checked value="SSign">否
                    <i class="fa fa-circle-o"></i>
                </label>
            </div>
            <div class="radio-inline">
                <label>
                    <input type="radio" name="signType"  value="USign"> 是
                    <i class="fa fa-circle-o"></i>
                </label>
            </div>
        </div>
    </div>
    <div class="row form-group"   style="width:95%;padding-left:8px;">
        <label class="col-md-5" >
            审批人：<div id='addCheckPerson'></div>
        </label>
        <div id='checkPersons' class="col-md-7">
            <div class="checkPersonOperation" > <div class="checkPersonName">123</div> <div class="deleteCheckPerson">删除</div> </div>
            <div class="checkPersonOperation" > <div class="checkPersonName">123</div> <div class="deleteCheckPerson">删除</div> </div>
            <div class="checkPersonOperation" > <div class="checkPersonName">123</div> <div class="deleteCheckPerson">删除</div> </div>
        </div>
    </div>
</div>

<script src="${srpp }/js/stringUtil.js"></script>
<script src="${srpp }/plugins/Canvas_FlowChart/Canvas_FlowChart.js"></script>
<script src="${srpp }/plugins/uuid/uuid.js"></script>
<script type="text/javascript">
    var $form = $('#${tabId}_Form');
    var flowJson = {listStep:[],flowCount:0,flowTitle:'',handleClass:'',status:0,remark:''};
    var getJsonIndex;//Json索引方法
    var count = 1;//总步骤数
    (function($){
        $(function(){
            var ${tabId}_oldFormValue;				//记录页面加载后form输入项值

            //新增输入框验证信息
            $('#${tabId}_Form').bootstrapValidator({
                message : '此项输入有错误',
                feedbackIcons : { /*input状态样式图片*/
                    valid : 'glyphicon glyphicon-ok',
                    invalid : 'glyphicon glyphicon-remove',
                },
                fields : {
                    'name' : {
                        validators : {
                            notEmpty : {
                                message : '请输入名称'
                            },
                            stringLength: {
                                min: 0,
                                max: 64,
                                message: '最多只允许输入32个字'
                            },
                        },
                    },
                    'status' : {
                        validators : {
                            notEmpty : {
                                message : '请输入状态'
                            },
                        },
                    },
                    'handleClass' : {
                        validators : {
                            notEmpty : {
                                message : '请输入处理Java类'
                            },
                            stringLength: {
                                min: 0,
                                max: 128,
                                message: '最多只允许输入128个字'
                            },
                        },
                    },
                    'remark' : {
                        validators : {
                            stringLength: {
                                min: 0,
                                max: 200,
                                message: '最多只允许输入200个字'
                            },
                        },
                    },
                }
            });

            //绑定提交按钮事件
            $('#btn_${tabId}_submit').click(function(){
                var bv = $form.data('bootstrapValidator');
                bv.validate();
                var canvas_data=c.outputData();
                if(canvas_data.length==0){
                    $('#canvas_area').removeClass('canvas_correct').addClass('canvas_wrong');
                }
                else{
                    $('#canvas_area').removeClass('canvas_wrong').addClass('canvas_correct');
                }
                if(bv.isValid()&&canvas_data.length>0){
                    flowJson.listStep=convertCanvasData(canvas_data);
                    flowJson.flowImg=c.canvas.toDataURL("image/jpeg");
                    flowJson.flowTitle = $('input[name="name"]').val();
                    flowJson.handleClass = $('input[name="handleClass"]').val();
                    flowJson.status = $('input[name="status"]').val();
                    flowJson.remark = $('textarea[name="remark"]').val();
                    console.log(flowJson);
                    $.ajax({
                        url:'${ctx}/flow/save/',
                        type:'POST', //GET
                        async:true,    //或false,是否异步
                        data:{
                            stepData:flowJson,
                        },
                        timeout:30000,
                        dataType:'json',
                        success:function(data,textStatus,jqXHR){
                            if (data.returnCode == 'success') {
                                datatableObj.ajax.reload(null,false);
                                layer.confirm(data.msg, {
                                    skin:'layer-ext-espresso',
                                    icon:1,
                                    title:'系统提示',
                                    btn: ['继续增加', '关闭'],
                                    yes:function(index){
                                        layer.close(index);
                                        bv.resetForm();
                                        $('#${tabId}_Form')[0].reset();
                                    },
                                    btn2:function(index){
                                        layer.close(index);
                                        closeTab('${tabId}');
                                    },
                                });
                            } else {
                                layer.alert(data.msg,{
                                    icon:0,
                                    title:'操作失败',
                                    btn: ['关闭'] ,
                                },function(index){
                                    layer.close(index);
                                    bv.resetForm();										//重置form元素状态
                                });
                            };
                        },
                        error:function(xhr,textStatus){
                            console.log(textStatus);
                        },
                    });
                }
            });

            //放弃按钮绑定关闭当前tab事件 closeTab
            $('#btn_${tabId}_cancel').click(function(){
                var newFormValue = $form.serialize();
                if(${tabId}_oldFormValue!=newFormValue){
                    layer.confirm('当前页正在编辑，是否确定关闭？', {
                            skin:'layer-ext-espresso',
                            icon:0,
                            title:'系统提示',
                            btn: ['确定', '返回'],
                        },function(index){
                            layer.close(index);
                            closeTab('${tabId}');
                        }
                    );
                }else{
                    closeTab('${tabId}');
                }
            });

            //保存form加载后的初始值，用于关闭时比较提示。
            ${tabId}_oldFormValue = $('#${tabId}_Form').serialize();



            //根据name 获取所在Json 索引
            getJsonIndex = function(json , name){
                for(var i=0;i<json.length;i++){
                    if(json[i].name==name){
                        return i;
                    };
                };
            };

        });
    })(jQuery);

</script>
<script type='text/javascript'>
    var c=new CanvasFlowChart('canvas_flowchart',{
        putCanvasBtnId:'put_canvas_btn',
    });
    c.init();
    c.myClickEvent=function () {

        updateLayer();
        var ParentIndex=layer.open({
            type: 1,
            title:'新增审批步骤',
            area:['360px','500px'],
            scrollbar:false,
            shade:0,
            shadeClose:true,
            content: $('#newStepDiv'),
            btn: ['确定', '关闭'],
            yes:function(index,layero){
                if($.isNull($('input[name="stepName"]').val())){
                    $('#err_StepName').css('display','block');
                    return;
                }
                $('#err_StepName').css('display','none');
                /* 将数据写入c.Canvas_lists */
                var shouldChangedItem=c.Canvas_lists[c.canvasInfoChangeIndex];
                shouldChangedItem.flowName=$('input[name="stepName"]').val();
                shouldChangedItem.text[0].value[0]=$('input[name="signType"]:checked').val()=='USign'?{data:'是',type:'USign'}:{data:'否',type:'SSign'};
                c.drawAll();
                //人员添加不走这 直接在选择审核用户点击确认添加
                layer.close(index);

            },
            btn2:function(index,layero){
                $('input[name="stepName"]').val("");
            },
            zIndex:1000,

        });
        /* $('.layui-layer-shade').css({zIndex:100}) */
    };

    $('#addCheckPerson').on('click',function(){
        layer.open({
            type: 2,
            title: '选择审核用户',
            area: ['750px', '550px'], //宽高
            content: '${ctx}/flow/selectAudiUser',
            btn:['确定','关闭'],
            yes:function(index,layero){
                var iframeWin = window[layero.find('iframe')[0]['name']];
                iframeWin.selectUser(c.canvasInfoChangeIndex);
                layer.close(index);

            },
            btn2:function(index){
                layer.close(index);
            },
            fixed: false,
            zIndex: layer.zIndex ,
            success: function(layero){
                layer.setTop(layero);
            }
        })
    })

    function updateLayer(){
        var shouldChangedItem=c.Canvas_lists[c.canvasInfoChangeIndex];
        //弹窗内容要和canvas-list中的保持一致
        $('#stepName').val(shouldChangedItem.flowName);
        console.log(shouldChangedItem.text[0].value[0].data)
        shouldChangedItem.text[0].value[0].data=='是'?$("input[name='signType'][value=USign]").attr("checked",true):$("input[name='signType'][value=SSign]").attr("checked",true);
        //人名 和 删除键
        var persons=shouldChangedItem.text[1].value;
        var length=persons.length;

        var renderString='';
        for(var i=0;i<length;i++){
            if(persons[i].data!=''){
                renderString+='<div class="checkPersonOperation" > <div class="checkPersonName">'+persons[i].operatorName+'</div><div class="checkPeronDepName">'+(persons[i].depName!=null?persons[i].depName:'')+'</div><div class="deleteCheckPerson" uIndex="'+persons[i].operatorId+'"></div> </div>'
            }
        }
        $('#checkPersons').html(renderString);
        //移除审核人
        $('.deleteCheckPerson').unbind().click(function(){
            delUser($(this).attr("uIndex"));
        });
    }

    //移除审核人员
    function delUser(uIndex){
        /* var newText=c.Canvas_lists[c.canvasInfoChangeIndex].text.slice(0);

         var userList=newText[1].value;

         userList.map(function(item,index){
         if(item.operatorId==uIndex){
         userList.splice(index,1);
         }
         })
         c.changeRectInfo(newText); */

        var rect=c.Canvas_lists[c.canvasInfoChangeIndex];
        var userList=rect.text[1].value;
        userList.map(function(item,index){
            if(item.operatorId==uIndex){
                userList.splice(index,1);
            }
        });
        rect.changeWH();

        updateLayer();
    };
    //判断审核用户是否已经存在？
    function checkUserExist(userId){
        var ucount = c.Canvas_lists[c.canvasInfoChangeIndex].text[1].value.length;
        var result = false;

        if(ucount==0){
            result= false;
        }else{
            for( var i=0;i<ucount;i++){
                if(c.Canvas_lists[c.canvasInfoChangeIndex].text[1].value[i].operatorId==userId){
                    result= true;
                    break;
                }else{
                    continue;
                };
            };
        };
        return result;
    }

    //执行增加用户
    function doAddUser(stepId,userId,userName,depName){


        if(checkUserExist(userId)){	//判断用户是否已存在
            layer.alert("【"+userName+"】在该步骤已存在",{
                icon:0,
                title:'系统提示',
                btn: ['关闭'] ,
            },function(index){
                layer.close(index);
            });

            return;
        }

        var user = {
            data:userName+(depName?('('+depName+')'):''),
            operatorName:userName,
            operatorId:userId,
            depName:depName,
        };
        /* var newText=c.Canvas_lists[c.canvasInfoChangeIndex].text;
         newText[1].value.push(user);
         */
        var rect=c.Canvas_lists[c.canvasInfoChangeIndex];
        rect.text[1].value.push(user);
        rect.changeWH();
        updateLayer();

    };

    function convertCanvasData(data_array){
        var data=[];
        for(var i=0;i<data_array.length;i++){
            var newObj={};
            newObj.x=data_array[i].x;
            newObj.y=data_array[i].y;
            newObj.stepTitle=data_array[i].flowName;
            newObj.id=UUID.generate();
            newObj.listOperator=data_array[i].text[1].value;
            newObj.userCount=data_array[i].text[1].value.length;
            (function(){newObj,name=i;})(i);
            newObj.signType=data_array[i].text[0].value[0].type;
            newObj.isCurrent=(data_array[i].isCurrent==true?true:false);
            data.push(newObj);
        }
        return data;
    }



</script>